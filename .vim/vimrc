" core
set mouse=a
let mapleader= " "
set title
set number relativenumber
set showmatch
set hlsearch
set linebreak " don't break words when wrapping
set hidden " leave buffers without abandoning
set list listchars=tab:»·,trail:·,nbsp:· " Display extra whitespace
set nojoinspaces " Use one space, not two, after punctuation.
set splitbelow " matches i3 behaviour
set splitright " matches i3 behaviour
set nowrap
set updatetime=100

" install plug.vim on new on new machines
if empty(glob('~/.vim/autoload/plug.vim'))
  silent !curl -fLo ~/.vim/autoload/plug.vim --create-dir https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
  autocmd VimEnter * PlugInstall --sync | source $MYVIMRC
endif

" plugins
call plug#begin('~/.vim/plugged')
source $HOME/.vim/file-tree.vim
source $HOME/.vim/functions.vim
source $HOME/.vim/language-server.vim
source $HOME/.vim/search.vim
source $HOME/.vim/terminal.vim
source $HOME/.vim/theme.vim
source $HOME/.vim/vcs.vim
source $HOME/.vim/wiki.vim

Plug 'godlygeek/tabular'
Plug 'mbbill/undotree'
Plug 'sheerun/vim-polyglot'
Plug 'tpope/vim-abolish'
Plug 'tpope/vim-commentary'
Plug 'tpope/vim-projectionist'
Plug 'tpope/vim-repeat'
Plug 'tpope/vim-sensible'
Plug 'tpope/vim-surround'
Plug 'tpope/vim-unimpaired'
call plug#end()

" undotree
nnoremap <leader>u :UndotreeToggle<cr>
if has("persistent_undo")
  set undodir=$HOME/.cache/vim/persistent_undo
  set undofile
endif

" Only show cursorline on focued window
augroup CursorLine
  au!
  au VimEnter,WinEnter,BufWinEnter * setlocal cursorline
  au WinLeave * setlocal nocursorline
augroup END

" tabs vs spaces
set tabstop=2
set softtabstop=2
set shiftwidth=2
set expandtab
augroup tabwidths
  autocmd!
  autocmd FileType elm,python set tabstop=4
  autocmd FileType elm,python set softtabstop=4
  autocmd FileType elm,python set shiftwidth=4
augroup END

" faster scrolling
nnoremap <c-y> 3<c-y>
nnoremap <c-e> 3<c-e>

" Quicker window movement
nnoremap <C-j> <C-w>j
nnoremap <C-k> <C-w>k
nnoremap <C-h> <C-w>h
nnoremap <C-l> <C-w>l

" toggle foldcolumn
nnoremap yof :set foldcolumn=<C-R>=&foldcolumn == 0 ? 2 : 0<CR><CR>
" don't auto open folds while moving by paragraph
set foldopen-=block

" %% to %:h to get active file dir in ex mode
cnoremap <expr> %% getcmdtype() == ':' ? expand('%:h').'/' : '%%'

" Copy filepath to system clipboard
nnoremap <leader>cp :let @+ = expand("%")<CR>
" Copy word/selection under cusor to system clipboard (Clipboard)
nnoremap <leader>cc "+yiw
vnoremap <leader>cc "+y

" disable exmode and commandline search
map q: <Nop>
nnoremap Q <nop>

" {{{ stuff from https://github.com/thoughtbot/dotfiles
augroup vimrcEx
  autocmd!
  " When editing a file, always jump to the last known cursor position.
  " Don't do it for commit messages, when the position is invalid, or when
  " inside an event handler (happens when dropping a file on gvim).
  autocmd BufReadPost *
    \ if &ft != 'gitcommit' && line("'\"") > 0 && line("'\"") <= line("$") |
    \   exe "normal g`\"" |
    \ endif
  " Set syntax highlighting for specific file types
  autocmd BufRead,BufNewFile *.md set filetype=markdown
  autocmd BufRead,BufNewFile .eslintrc,tsconfig.json set filetype=json5
augroup END
" }}}

let g:markdown_fenced_languages = ['python']

augroup downsheet
  autocmd!
  autocmd BufRead,BufNewFile *.dsh set filetype=toml
  autocmd BufRead,BufNewFile *.dsh set nowrap
  autocmd BufWritePre *.dsh :%!dsc
augroup END
